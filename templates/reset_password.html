{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
    <title>Reset Password - Student Management System</title>
    <link rel="shortcut icon" href="{% static 'assets/img/favicon.png' %}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,500;0,600;0,700;1,400&display=swap">
    <link rel="stylesheet" href="{% static 'assets/plugins/bootstrap/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/plugins/fontawesome/css/fontawesome.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/plugins/fontawesome/css/all.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
</head>
<body>
    <div class="main-wrapper login-body">
        <div class="login-wrapper">
            <div class="container">
                <div class="loginbox">
                    <div class="login-left">
                        {% comment %} <img class="img-fluid" src="{% static 'assets/img/logo-white.png' %}" alt="Logo"> {% endcomment %}
                    </div>
                    <div class="login-right">
                        <div class="login-right-wrap">
                            {% if validlink %}
                                <div class="text-center mb-3">
                                    <div class="avatar avatar-lg mb-3">
                                        <span class="avatar-title rounded-circle bg-success-light text-success">
                                            <i class="fas fa-key fa-2x"></i>
                                        </span>
                                    </div>
                                </div>
                                <h1>Reset Password</h1>
                                <p class="account-subtitle">Enter your new password</p>

                                {% if user %}
                                    <div class="alert alert-info">
                                        <strong>Account:</strong> {{ user.first_name }} {{ user.last_name }}<br>
                                        <strong>User ID:</strong> {{ user.user_id }}
                                    </div>
                                {% endif %}

                                {% if messages %}
                                    {% for message in messages %}
                                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                            {{ message }}
                                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                    {% endfor %}
                                {% endif %}

                                <form method="POST">
                                    {% csrf_token %}

                                    <!-- New Password -->
                                    <div class="form-group">
                                        <label>New Password <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="password" name="new_password" id="new_password"
                                                   class="form-control" placeholder="Enter new password" required>
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="button"
                                                        onclick="togglePassword('new_password')">
                                                    <i class="far fa-eye" id="new_password_icon"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <small class="form-text text-muted">
                                            Password must be at least 8 characters long
                                        </small>
                                    </div>

                                    <!-- Confirm Password -->
                                    <div class="form-group">
                                        <label>Confirm New Password <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="password" name="confirm_password" id="confirm_password"
                                                   class="form-control" placeholder="Re-enter new password" required>
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="button"
                                                        onclick="togglePassword('confirm_password')">
                                                    <i class="far fa-eye" id="confirm_password_icon"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Password Strength Indicator -->
                                    <div class="form-group">
                                        <label>Password Strength</label>
                                        <div class="progress" style="height: 8px;">
                                            <div id="password-strength" class="progress-bar" role="progressbar"
                                                 style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                        <small id="strength-text" class="form-text text-muted"></small>
                                    </div>

                                    <div class="form-group">
                                        <button class="btn btn-success btn-block" type="submit">
                                            <i class="fas fa-check mr-2"></i>Reset Password
                                        </button>
                                    </div>
                                </form>

                                <div class="mt-3 p-3 bg-light rounded">
                                    <p class="mb-2"><strong><i class="fas fa-info-circle text-primary mr-2"></i>Password Requirements:</strong></p>
                                    <ul class="list-unstyled mb-0 small">
                                        <li><i class="fas fa-check-circle text-success mr-2"></i>At least 8 characters long</li>
                                        <li><i class="fas fa-check-circle text-success mr-2"></i>Mix of uppercase and lowercase letters</li>
                                        <li><i class="fas fa-check-circle text-success mr-2"></i>Include numbers and special characters</li>
                                    </ul>
                                </div>

                            {% else %}
                                <!-- Invalid or Expired Link -->
                                <div class="text-center mb-3">
                                    <div class="avatar avatar-lg mb-3">
                                        <span class="avatar-title rounded-circle bg-danger-light text-danger">
                                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                                        </span>
                                    </div>
                                </div>
                                <h1>Invalid Link</h1>
                                <p class="account-subtitle">This password reset link is invalid or has expired</p>

                                {% if messages %}
                                    {% for message in messages %}
                                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                            {{ message }}
                                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                    {% endfor %}
                                {% endif %}

                                <div class="alert alert-warning">
                                    <strong>What happened?</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>The password reset link has expired (valid for 24 hours)</li>
                                        <li>The link has already been used</li>
                                        <li>The link is incorrect or corrupted</li>
                                    </ul>
                                </div>

                                <div class="form-group">
                                    <a href="{% url 'forgot_password' %}" class="btn btn-primary btn-block">
                                        <i class="fas fa-redo mr-2"></i>Request New Reset Link
                                    </a>
                                </div>
                            {% endif %}

                            <div class="text-center mt-3">
                                <a href="{% url 'login_page' %}" class="text-muted">
                                    <i class="fas fa-arrow-left mr-2"></i>Back to Login
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{% static 'assets/js/jquery-3.6.0.min.js' %}"></script>
    <script src="{% static 'assets/js/popper.min.js' %}"></script>
    <script src="{% static 'assets/plugins/bootstrap/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'assets/js/script.js' %}"></script>

    {% if validlink %}
    <!-- Toggle Password Visibility Script -->
    <script>
    function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const icon = document.getElementById(fieldId + '_icon');

        if (field.type === 'password') {
            field.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            field.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    // Password Strength Checker
    document.getElementById('new_password').addEventListener('keyup', function() {
        const password = this.value;
        const strengthBar = document.getElementById('password-strength');
        const strengthText = document.getElementById('strength-text');

        let strength = 0;
        let strengthLabel = '';
        let strengthColor = '';

        // Calculate strength
        if (password.length >= 8) strength += 25;
        if (password.match(/[a-z]+/)) strength += 25;
        if (password.match(/[A-Z]+/)) strength += 25;
        if (password.match(/[0-9]+/)) strength += 12.5;
        if (password.match(/[$@#&!]+/)) strength += 12.5;

        // Set strength label and color
        if (strength === 0) {
            strengthLabel = '';
            strengthColor = '';
        } else if (strength <= 25) {
            strengthLabel = 'Weak';
            strengthColor = 'bg-danger';
        } else if (strength <= 50) {
            strengthLabel = 'Fair';
            strengthColor = 'bg-warning';
        } else if (strength <= 75) {
            strengthLabel = 'Good';
            strengthColor = 'bg-info';
        } else {
            strengthLabel = 'Strong';
            strengthColor = 'bg-success';
        }

        strengthBar.style.width = strength + '%';
        strengthBar.className = 'progress-bar ' + strengthColor;
        strengthText.textContent = strengthLabel;
        strengthText.className = 'form-text ' + (strengthColor ? strengthColor.replace('bg-', 'text-') : 'text-muted');
    });

    // Confirm Password Match Validation
    document.getElementById('confirm_password').addEventListener('keyup', function() {
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = this.value;

        if (confirmPassword.length > 0) {
            if (newPassword === confirmPassword) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        } else {
            this.classList.remove('is-valid', 'is-invalid');
        }
    });
    </script>
    {% endif %}
</body>
</html>
